<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NOA ç®¡ç†ç”»é¢</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>
  <main class="container">
    <h1>ç®¡ç†ç”»é¢</h1>
    <p>å„ã‚¨ãƒªã‚¢ã®çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <div class="controls">
      <!-- Shop Status -->
      <section class="admin-section">
        <h2>å–¶æ¥­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <div class="status-options">
          <label><input type="radio" name="shopStatus" value="open" checked> é€šå¸¸å–¶æ¥­</label>
          <label><input type="radio" name="shopStatus" value="holiday"> å®šä¼‘æ—¥</label>
          <label><input type="radio" name="shopStatus" value="reserved"> è²¸åˆ‡</label>
          <label><input type="radio" name="shopStatus" value="closed"> çµ‚äº†</label>
        </div>
      </section>

      <!-- Cast Status -->
      <section class="admin-section">
        <h2>ã‚­ãƒ£ã‚¹ãƒˆå‡ºå‹¤</h2>
        <div id="cast-container" class="cast-toggles">
          <!-- Dynamically populated -->
        </div>

        <div class="add-cast-form">
          <h3>ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ </h3>
          <input type="text" id="new-cast-name" placeholder="ä¾‹: HANAKO (ã¯ãªã“)" />
          <button id="btn-add-cast">è¿½åŠ </button>
        </div>
      </section>

      <div class="divider"></div>

      <p>å„ã‚¨ãƒªã‚¢ã®çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <section>
        <h2>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</h2>
        <div class="btns" data-area="counter">
          <button data-status="green">VACANT<br><small>ç©ºå¸­</small></button>
          <button data-status="yellow">LIMITED<br><small>æ®‹ã‚Šã‚ãšã‹</small></button>
          <button data-status="red">FULL<br><small>æº€å¸­</small></button>
        </div>
      </section>
      <section>
        <h2>ãƒœãƒƒã‚¯ã‚¹å¸­</h2>
        <div class="btns" data-area="box">
          <button data-status="green">VACANT<br><small>ç©ºå¸­</small></button>
          <button data-status="yellow">LIMITED<br><small>æ®‹ã‚Šã‚ãšã‹</small></button>
          <button data-status="red">FULL<br><small>æº€å¸­</small></button>
        </div>
      </section>
    </div>
    <p id="msg"></p>
    <p><a href="/">å…¬é–‹ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a></p>
  </main>
  <script>
    const msg = document.getElementById('msg');
    const castContainer = document.getElementById('cast-container');

    // Generic API poster
    async function apiPost(payload) {
      const res = await fetch('/api/status-v2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        msg.textContent = 'æ›´æ–°ã—ã¾ã—ãŸ';
        msg.style.color = 'green';
        setTimeout(() => msg.textContent = '', 2000);
        await init(); // Refresh UI
      } else {
        const txt = await res.text();
        msg.textContent = `æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status}): ${txt}`;
        msg.style.color = 'red';
      }
      return res;
    }

    // Initialize
    async function init() {
      const res = await fetch('/api/status-v2');
      const data = await res.json();

      // Shop Status
      if (data.shopStatus) {
        const radio = document.querySelector(`input[name="shopStatus"][value="${data.shopStatus}"]`);
        if (radio) radio.checked = true;
      }

      // Cast Status
      renderCast(data.cast || {});
    }

    function renderCast(castData) {
      castContainer.innerHTML = '';
      Object.values(castData).forEach(member => {
        const wrapper = document.createElement('div');
        wrapper.className = 'cast-control';

        // Toggle Button
        const btn = document.createElement('button');
        btn.className = member.isPresent ? 'cast-btn active' : 'cast-btn';
        btn.textContent = member.name;
        btn.onclick = () => {
          apiPost({ castUpdate: { id: member.id, isPresent: !member.isPresent } });
        };

        // Delete Button
        const delBtn = document.createElement('button');
        delBtn.textContent = 'ğŸ—‘ï¸';
        delBtn.className = 'delete-btn';
        delBtn.onclick = () => {
          if (confirm(`${member.name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            apiPost({ removeCast: { id: member.id } });
          }
        };

        wrapper.appendChild(btn);
        wrapper.appendChild(delBtn);
        castContainer.appendChild(wrapper);
      });
    }

    init();

    // Shop Status Listeners
    document.querySelectorAll('input[name="shopStatus"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        apiPost({ shopStatus: e.target.value });
      });
    });

    // Add Cast Listener
    document.getElementById('btn-add-cast').addEventListener('click', () => {
      const nameInput = document.getElementById('new-cast-name');
      const name = nameInput.value.trim();
      if (!name) return;

      // Simple ID generation
      const id = 'cast_' + Date.now();
      apiPost({ addCast: { id, name } });
      nameInput.value = '';
    });

    // Seat Buttons Listeners
    document.querySelectorAll('.btns').forEach(group => {
      group.addEventListener('click', async (e) => {
        if (!e.target.closest('button')) return;
        const btn = e.target.closest('button');
        const area = group.dataset.area;
        const status = btn.dataset.status;
        await apiPost({ area, status });
      });
    });
  </script>
</body>

</html>